{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
    :root {
        --ios-primary: #007AFF;
        --ios-bg: #f2f2f7;
        --ios-card: #ffffff;
        --ios-input-bg: #f2f2f7;
        --creator-color: #000000;
        --ios-border: rgba(0, 0, 0, 0.08);
        --ios-text: #1c1c1e;
        --ios-secondary-text: #8e8e93;
    }

    [data-bs-theme="dark"] {
        --ios-bg: #000000;
        --ios-card: #1c1c1e;
        --ios-input-bg: #2c2c2e;
        --creator-color: #ffffff;
        --ios-border: rgba(255, 255, 255, 0.12);
        --ios-text: #f5f5f7;
    }

    body {
        background-color: var(--ios-bg);
        color: var(--ios-text);
        transition: background 0.3s ease;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        -webkit-font-smoothing: antialiased;
    }

    /* ✨ Profile Card */
    .profile-card {
        background-color: var(--ios-card);
        border-radius: 24px;
        border: 1px solid var(--ios-border);
        box-shadow: 0 10px 30px rgba(0,0,0,0.03);
        backdrop-filter: blur(20px);
    }

    .avatar-main {
        width: 125px; height: 125px;
        object-fit: cover; border-radius: 50%;
        border: 3.5px solid var(--ios-primary);
        padding: 2px; background: var(--ios-card);
    }

    /* ✨ Post Card */
    .post-card {
        background-color: var(--ios-card);
        border-radius: 22px;
        border: 1px solid var(--ios-border);
        animation: iosSlideUp 0.5s cubic-bezier(0.1, 0.8, 0.2, 1);
    }

    @keyframes iosSlideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .role-mark { font-size: 1.1rem; vertical-align: middle; margin-left: 3px; }
    .mark-developer { color: #007AFF; }
    .mark-inspector { color: #34C759; }
    .mark-official { color: #FF9F0A; }
    .mark-creator { color: var(--creator-color) !important; }

    /* ✨ Buttons */
    .btn-ios {
        border-radius: 12px; font-weight: 600;
        padding: 10px 24px; transition: 0.2s;
        border: none; font-size: 15px;
    }
    .btn-ios-primary { background-color: var(--ios-primary); color: white; }
    .btn-ios-secondary { background-color: var(--ios-input-bg); color: var(--ios-primary); }
    .btn-ios:active { transform: scale(0.95); }

    /* ✨ Enhanced Comment UI */
    .comment-bubble {
        background-color: var(--ios-input-bg);
        border-radius: 18px;
        padding: 10px 14px;
        font-size: 0.92rem;
        display: inline-block;
        max-width: 100%;
    }

    .comment-action-btn {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--ios-secondary-text);
        cursor: pointer;
        margin-right: 12px;
        text-decoration: none;
    }
    .comment-action-btn:hover { color: var(--ios-primary); }
    .delete-btn:hover { color: #ff3b30; }

    /* Reply Styling */
    .reply-thread {
        border-left: 2px solid var(--ios-border);
        margin-left: 20px;
        padding-left: 15px;
    }

    .reply-input-container {
        display: none;
        margin-top: 10px;
    }

    .post-image {
        border-radius: 18px; margin-top: 10px;
        width: 100%; max-height: 500px; object-fit: cover;
    }

    /* Friends Section Inside Profile */
    .friends-list-container {
        background-color: var(--ios-card);
        border-radius: 20px;
        border: 1px solid var(--ios-border);
        overflow: hidden;
    }
    .friend-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        text-decoration: none;
        color: inherit;
        border-bottom: 1px solid var(--ios-border);
    }
    .friend-item:last-child { border-bottom: none; }
    .friend-item:hover { background-color: var(--ios-input-bg); }
</style>

<div class="row justify-content-center mt-4 px-2">
    <div class="col-md-8 col-lg-6">

        <div class="profile-card text-center p-4 mb-4 position-relative">
            {% if viewed_user == user %}
                <div class="position-absolute top-0 end-0 m-3">
                    <a href="{% url 'edit_profile' %}" class="btn btn-ios-secondary btn-sm rounded-pill px-3">
                        <i class="bi bi-pencil-fill me-1"></i> Edit
                    </a>
                </div>
            {% endif %}

            <div class="mb-3">
                {% if viewed_user.profile.profile_pic %}
                    <img src="{{ viewed_user.profile.profile_pic.url }}" class="avatar-main">
                {% else %}
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center text-secondary" style="width: 125px; height: 125px; border: 4px solid var(--ios-primary);">
                        <i class="bi bi-person-fill" style="font-size: 4.5rem;"></i>
                    </div>
                {% endif %}
            </div>

            <h3 class="fw-bold mb-0">
                {{ viewed_user.username }}
                {% if viewed_user.profile.role == 'developer' %}
                    <i class="bi bi-patch-check-fill role-mark mark-developer"></i>
                {% elif viewed_user.profile.role == 'app inspector' %}
                    <i class="bi bi-check-circle-fill role-mark mark-inspector"></i>
                {% elif viewed_user.profile.role == 'Official' or viewed_user.username == 'TalkOfficialBot' %}
                    <i class="bi bi-patch-check-fill role-mark mark-official"></i>
                {% elif viewed_user.profile.role == 'creator' %}
                    <i class="bi bi-patch-check-fill role-mark mark-creator"></i>
                {% endif %}
            </h3>

            <p class="text-primary fw-bold small mb-1">@{{ viewed_user.profile.talk_id }}</p>

            <a href="#friends-section" class="text-decoration-none d-block mb-2">
                <span class="badge rounded-pill bg-light text-primary border px-3">
                    {{ viewed_user.profile.friends.count }} Friends
                </span>
            </a>

            <p class="text-muted px-4" style="font-size: 0.95rem;">{{ viewed_user.profile.bio|default:"No bio yet." }}</p>

            <div class="d-flex justify-content-center gap-2 mt-4">
                {% if viewed_user != user %}
                    {% if is_bot %}
                        <a href="{% url 'chat_room' viewed_user.username %}" class="btn btn-ios btn-ios-primary px-5">Chat with Bot</a>
                    {% elif is_blocked %}
                        <a href="{% url 'unblock_user' viewed_user.id %}" class="btn btn-danger btn-ios px-4">Unblock User</a>
                    {% else %}
                        {% if is_friend %}
                            <a href="{% url 'chat_room' viewed_user.username %}" class="btn btn-ios btn-ios-primary px-4">Message</a>
                            <button onclick="unfriendUser('{{ viewed_user.id }}')" class="btn btn-ios btn-ios-secondary px-3">Unfriend</button>
                        {% elif sent_request %}
                            <a href="{% url 'cancel_friend_request' viewed_user.id %}" class="btn btn-ios btn-ios-secondary px-4">Cancel Request</a>
                        {% elif received_request %}
                            <a href="{% url 'notifications' %}" class="btn btn-success btn-ios px-4 text-white">Accept Request</a>
                        {% else %}
                            <a href="{% url 'send_friend_request' viewed_user.id %}" class="btn btn-ios btn-ios-primary px-4">Add Friend</a>
                        {% endif %}
                        <a href="{% url 'block_user' viewed_user.id %}" class="btn btn-outline-danger btn-ios" onclick="return confirm('Block this user?')">Block</a>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        {% if not is_bot %}
        <div id="friends-section" class="mb-4">
            <h5 class="fw-bold mb-3 px-2 d-flex align-items-center">
                <i class="bi bi-people-fill me-2 text-primary"></i> Friends
            </h5>
            <div class="friends-list-container">
                {% for friend in viewed_user.profile.friends.all|slice:":5" %}
                    <a href="{% url 'profile_view' friend.username %}" class="friend-item">
                        <img src="{{ friend.profile.profile_pic.url|default:'/static/default_user.png' }}" class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
                        <div class="flex-grow-1">
                            <div class="fw-bold" style="font-size: 14px;">{{ friend.username }}</div>
                            <div class="text-muted small">@{{ friend.profile.talk_id }}</div>
                        </div>
                        <i class="bi bi-chevron-right text-muted"></i>
                    </a>
                {% empty %}
                    <div class="p-4 text-center text-muted small">No friends to show.</div>
                {% endfor %}

                {% if viewed_user.profile.friends.count > 5 %}
                <a href="{% url 'all_friends_view' viewed_user.username %}" class="friend-item justify-content-center text-primary fw-bold small">
                    See All Friends ({{ viewed_user.profile.friends.count }})
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if not is_bot %}
            <h5 class="fw-bold mb-3 px-2 d-flex align-items-center">
                <i class="bi bi-grid-fill me-2 text-primary"></i> Posts
            </h5>

            {% for post in user_posts %}
                <div class="post-card p-3 mb-4" id="post-{{ post.id }}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-2">
                             <img src="{{ viewed_user.profile.profile_pic.url|default:'/static/default_user.png' }}" class="rounded-circle" width="38" height="38" style="object-fit: cover;">
                             <div>
                                 <div class="fw-bold" style="font-size: 14px;">{{ viewed_user.username }}</div>
                                 <div class="text-muted" style="font-size: 11px;">{{ post.created_at|timesince }} ago</div>
                             </div>
                        </div>
                        {% if viewed_user == user or user.is_staff %}
                            <div class="dropdown">
                                <i class="bi bi-three-dots px-2 opacity-50" data-bs-toggle="dropdown" style="cursor: pointer;"></i>
                                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg">
                                    <li><a class="dropdown-item py-2 text-danger fw-bold" href="{% url 'delete_post' post.pk %}" onclick="return confirm('Delete post?')"><i class="bi bi-trash me-2"></i> Delete</a></li>
                                </ul>
                            </div>
                        {% endif %}
                    </div>

                    <div class="px-1 mb-2" style="white-space: pre-wrap; font-size: 15px;">{{ post.content }}</div>

                    {% if post.image %}
                        <img src="{{ post.image.url }}" class="post-image mb-3 shadow-sm">
                    {% endif %}

                    <div class="d-flex gap-4 border-top pt-3 mt-2">
                        <button onclick="likePost('{{ post.id }}')" class="btn btn-link text-decoration-none p-0 shadow-none d-flex align-items-center gap-2">
                            <i class="bi {% if user in post.likes.all %}bi-heart-fill text-danger{% else %}bi-heart text-muted{% endif %}" id="like-icon-{{ post.id }}" style="font-size: 1.3rem;"></i>
                            <span class="fw-bold text-muted" id="like-count-{{ post.id }}">{{ post.likes.count }}</span>
                        </button>
                        <button class="btn btn-link text-muted text-decoration-none p-0 shadow-none d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#commentModal{{ post.id }}">
                            <i class="bi bi-chat-dots" style="font-size: 1.3rem;"></i>
                            <span class="fw-bold" id="comment-count-{{ post.id }}">{{ post.comments.count }}</span>
                        </button>
                    </div>
                </div>

                <div class="modal fade" id="commentModal{{ post.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                        <div class="modal-content border-0 shadow-lg" style="border-radius: 30px; background-color: var(--ios-card);">
                            <div class="modal-header border-0 pb-0">
                                <h6 class="fw-bold mx-auto">Comments</h6>
                                <button type="button" class="btn-close shadow-none position-absolute end-0 me-3" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body px-3 mt-2" style="min-height: 400px;">
                                <div id="inner-comments-{{ post.id }}">
                                    {% for comment in post.comments.all %}
                                        {% if not comment.parent %}
                                            <div class="mb-3" id="comment-container-{{ comment.id }}">
                                                <div class="d-flex gap-2">
                                                    <img src="{{ comment.user.profile.profile_pic.url|default:'/static/default_user.png' }}" class="rounded-circle" width="35" height="35" style="object-fit: cover;">
                                                    <div class="flex-grow-1">
                                                        <div class="comment-bubble">
                                                            <div class="fw-bold text-primary" style="font-size: 0.85rem;">{{ comment.user.username }}</div>
                                                            <div class="comment-text">{{ comment.content }}</div>
                                                        </div>
                                                        <div class="mt-1 ms-2 d-flex align-items-center">
                                                            <span class="text-muted me-3" style="font-size: 0.7rem;">{{ comment.created_at|timesince }}</span>
                                                            <span class="comment-action-btn" onclick="toggleReply('{{ comment.id }}')">Reply</span>
                                                            {% if comment.user == user or user.is_staff %}
                                                                <span class="comment-action-btn delete-btn" onclick="deleteComment('{{ comment.id }}', '{{ post.id }}')">Delete</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="reply-input-container" id="reply-box-{{ comment.id }}">
                                                            <form onsubmit="submitComment(event, '{{ post.id }}', '{{ comment.id }}')" class="d-flex gap-2 mt-2">
                                                                <input type="text" id="reply-input-{{ comment.id }}" class="form-control form-control-sm rounded-pill bg-light border-0 shadow-none px-3" placeholder="Reply to {{ comment.user.username }}...">
                                                                <button type="submit" class="btn btn-primary btn-sm rounded-circle p-0 d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;"><i class="bi bi-arrow-up-short fs-4"></i></button>
                                                            </form>
                                                        </div>
                                                        <div class="reply-thread mt-2" id="replies-{{ comment.id }}">
                                                            {% for reply in comment.replies.all %}
                                                                <div class="mb-2 d-flex gap-2" id="comment-container-{{ reply.id }}">
                                                                    <img src="{{ reply.user.profile.profile_pic.url|default:'/static/default_user.png' }}" class="rounded-circle" width="28" height="28" style="object-fit: cover;">
                                                                    <div class="flex-grow-1">
                                                                        <div class="comment-bubble py-1 px-3">
                                                                            <div class="fw-bold text-primary" style="font-size: 0.8rem;">{{ reply.user.username }}</div>
                                                                            <div class="comment-text" style="font-size: 0.85rem;">{{ reply.content }}</div>
                                                                        </div>
                                                                        <div class="mt-1 ms-1 d-flex align-items-center">
                                                                            <span class="text-muted me-3" style="font-size: 0.65rem;">{{ reply.created_at|timesince }}</span>
                                                                            {% if reply.user == user or user.is_staff %}
                                                                                <span class="comment-action-btn delete-btn" onclick="deleteComment('{{ reply.id }}', '{{ post.id }}')">Delete</span>
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% empty %}
                                        <div class="text-center text-muted mt-5 py-5 opacity-50 empty-msg">
                                            <i class="bi bi-chat-square-text fs-1"></i>
                                            <p class="small mt-2">No comments yet.</p>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="modal-footer border-0 p-3">
                                <form onsubmit="submitComment(event, '{{ post.id }}')" class="w-100">
                                    <div class="d-flex gap-2 align-items-center rounded-pill px-2 py-1" style="background-color: var(--ios-input-bg);">
                                        <input type="text" id="comment-input-{{ post.id }}" class="form-control bg-transparent border-0 shadow-none px-3" placeholder="Write a comment..." required autocomplete="off">
                                        <button type="submit" class="btn btn-primary rounded-circle p-0 d-flex align-items-center justify-content-center" style="width: 38px; height: 38px;">
                                            <i class="bi bi-arrow-up-short fs-3"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center mt-5 p-5 opacity-50">
                <i class="bi bi-robot" style="font-size: 4rem;"></i>
                <p class="mt-3 fw-bold">System Account</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
    // ✅ Toggle Reply Input
    function toggleReply(commentId) {
        const box = document.getElementById(`reply-box-${commentId}`);
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
        if(box.style.display === 'block') box.querySelector('input').focus();
    }

    // ✅ Like Post (AJAX)
    function likePost(postId) {
        fetch(`/like/${postId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(res => res.json())
        .then(data => {
            const icon = document.getElementById(`like-icon-${postId}`);
            const count = document.getElementById(`like-count-${postId}`);
            if(data.liked) {
                icon.classList.replace('bi-heart', 'bi-heart-fill');
                icon.classList.add('text-danger');
            } else {
                icon.classList.replace('bi-heart-fill', 'bi-heart');
                icon.classList.remove('text-danger');
            }
            count.innerText = data.like_count;
        });
    }

    // ✅ Submit Comment & Reply (AJAX)
    async function submitComment(event, postId, parentId = null) {
        event.preventDefault();
        const inputId = parentId ? `reply-input-${parentId}` : `comment-input-${postId}`;
        const input = document.getElementById(inputId);
        const content = input.value;
        if(!content.trim()) return;

        const formData = new FormData();
        formData.append('content', content);
        if(parentId) formData.append('parent_id', parentId);

        try {
            const res = await fetch(`/add_comment/${postId}/`, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            const data = await res.json();

            if (data.status === 'success') {
                input.value = '';
                if(parentId) document.getElementById(`reply-box-${parentId}`).style.display = 'none';

                const newCommentHtml = `
                    <div class="mb-3" id="comment-container-${data.comment_id}" style="animation: iosSlideUp 0.3s ease;">
                        <div class="d-flex gap-2">
                            <img src="${data.profile_pic}" class="rounded-circle" width="${parentId ? '28' : '35'}" height="${parentId ? '28' : '35'}" style="object-fit: cover;">
                            <div class="flex-grow-1">
                                <div class="comment-bubble ${parentId ? 'py-1 px-3' : ''}">
                                    <div class="fw-bold text-primary" style="font-size: ${parentId ? '0.8rem' : '0.85rem'};">${data.username}</div>
                                    <div class="comment-text" style="font-size: ${parentId ? '0.85rem' : '0.92rem'};">${data.content}</div>
                                </div>
                                <div class="mt-1 ms-2 d-flex align-items-center">
                                    <span class="text-muted me-3" style="font-size: 0.7rem;">Just now</span>
                                    ${!parentId ? `<span class="comment-action-btn" onclick="toggleReply('${data.comment_id}')">Reply</span>` : ''}
                                    <span class="comment-action-btn delete-btn" onclick="deleteComment('${data.comment_id}', '${postId}')">Delete</span>
                                </div>
                                <div class="reply-thread mt-2" id="replies-${data.comment_id}"></div>
                            </div>
                        </div>
                    </div>`;

                if(parentId) {
                    document.getElementById(`replies-${parentId}`).insertAdjacentHTML('beforeend', newCommentHtml);
                } else {
                    const container = document.getElementById(`inner-comments-${postId}`);
                    const emptyMsg = container.querySelector('.empty-msg');
                    if(emptyMsg) emptyMsg.remove();
                    container.insertAdjacentHTML('beforeend', newCommentHtml);
                }
                document.getElementById(`comment-count-${postId}`).innerText = data.comment_count;
            }
        } catch (err) { console.error("Error sending comment"); }
    }

    // ✅ Delete Comment (AJAX)
    async function deleteComment(commentId, postId) {
        if (!confirm('Delete this comment?')) return;
        try {
            const res = await fetch(`/comment/delete/${commentId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            const data = await res.json();
            if (data.status === 'success') {
                const element = document.getElementById(`comment-container-${commentId}`);
                element.style.opacity = '0';
                setTimeout(() => {
                    element.remove();
                    document.getElementById(`comment-count-${postId}`).innerText = data.comment_count;
                }, 300);
            }
        } catch (err) { alert("Delete failed"); }
    }

    function unfriendUser(userId) {
        if(!confirm('Unfriend this user?')) return;
        fetch(`/unfriend/${userId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        }).then(() => location.reload());
    }
</script>
{% endblock %}