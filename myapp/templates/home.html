{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
     :root {
          --ios-card-bg: rgba(255, 255, 255, 0.85);
          --ios-input-bg: #f2f2f7;
          --ios-text: #1c1c1e;
          --ios-border: rgba(0, 0, 0, 0.08);
          --ios-primary: #007AFF;
          --glass-accent: rgba(255, 255, 255, 0.4);
          --creator-badge-color: #000000;
     }

     [data-bs-theme="dark"] {
          --ios-card-bg: rgba(28, 28, 30, 0.85);
          --ios-input-bg: #1c1c1e;
          --ios-text: #f5f5f7;
          --ios-border: rgba(255, 255, 255, 0.12);
          --ios-primary: #0A84FF;
          --glass-accent: rgba(0, 0, 0, 0.4);
          --creator-badge-color: #ffffff;
     }

     body {
          background: var(--ios-input-bg);
          color: var(--ios-text);
          font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
          -webkit-font-smoothing: antialiased;
     }

     /* ✨ Story: Capsule Style & Messenger Note Style */
     .story-container {
          display: flex; gap: 12px; overflow-x: auto;
          padding: 25px 5px 15px 5px; scrollbar-width: none;
          -ms-overflow-style: none;
          align-items: flex-end;
     }
     .story-container::-webkit-scrollbar { display: none; }

     .story-item {
          min-width: 85px;
          background: var(--ios-card-bg);
          padding: 10px 5px;
          border-radius: 42px;
          border: 1px solid var(--ios-border);
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          backdrop-filter: blur(15px);
          -webkit-backdrop-filter: blur(15px);
          position: relative;
          display: flex;
          flex-direction: column;
          align-items: center;
     }
     .story-item:active { transform: scale(0.92); }

     /* Messenger-style Note Bubble */
     .story-note-bubble {
          position: absolute;
          top: -28px;
          background: var(--ios-card-bg);
          border: 1px solid var(--ios-border);
          border-radius: 18px;
          padding: 6px 12px;
          font-size: 11px;
          max-width: 100px;
          max-height: 50px;
          overflow: hidden;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          z-index: 5;
          word-break: break-word;
          animation: float 3s ease-in-out infinite;
          line-height: 1.2;
     }

     .story-note-bubble::after {
          content: '';
          position: absolute;
          bottom: -5px;
          left: 50%;
          transform: translateX(-50%);
          border-left: 6px solid transparent;
          border-right: 6px solid transparent;
          border-top: 6px solid var(--ios-card-bg);
     }

     @keyframes float {
          0% { transform: translate(-50%, 0px); left: 50%; }
          50% { transform: translate(-50%, -4px); left: 50%; }
          100% { transform: translate(-50%, 0px); left: 50%; }
     }

     .story-img-wrapper {
          width: 58px; height: 58px; border-radius: 50%; padding: 2px;
          background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
          margin: 0 auto 6px auto;
          position: relative;
          z-index: 1;
     }
     .story-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--ios-card-bg); }

     /* Text-only story style */
     .text-story-preview {
          width: 100%; height: 100%; border-radius: 50%;
          display: flex; align-items: center; justify-content: center;
          background: linear-gradient(45deg, #5856d6, #007AFF); color: white; font-size: 8px; font-weight: bold;
          text-align: center; padding: 5px; border: 2px solid var(--ios-card-bg);
          overflow: hidden; word-break: break-all;
     }

     /* ✨ Post Card Style */
     .post-card {
          background: var(--ios-card-bg) !important;
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border-radius: 24px;
          margin-bottom: 20px;
          padding: 20px;
          border: 1px solid var(--ios-border);
          box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
     }

     .post-input {
          border-radius: 16px; background-color: var(--ios-input-bg) !important;
          border: 1px solid var(--ios-border); padding: 12px 15px; color: var(--ios-text) !important;
          font-size: 15px; resize: none;
     }

     .role-mark { font-size: 13px; margin-left: 2px; }
     .mark-developer { color: var(--ios-primary); }
     .mark-inspector { color: #34C759; }
     .mark-official { color: #FF9F0A; }

     .action-btn {
          border-radius: 12px;
          padding: 8px 14px;
          color: var(--ios-text);
          opacity: 0.85;
          font-weight: 600;
          font-size: 14px;
          border: none;
          background: transparent;
          transition: 0.2s;
     }

     .comment-bubble { background-color: var(--ios-input-bg); border-radius: 18px; padding: 10px 14px; position: relative; }
     .reply-box { margin-left: 40px; border-left: 2px solid var(--ios-border); padding-left: 10px; }

     .time-text { font-size: 10px; color: #8e8e93; }
     .comment-action-btn { font-size: 12px; font-weight: 600; cursor: pointer; color: var(--ios-primary); margin-right: 10px; }
</style>

<div class="container">
     <div class="row justify-content-center">
          <div class="col-md-8 col-lg-6 px-3 mt-3">

               <div class="story-container">
                    <div class="story-item text-center" data-bs-toggle="modal" data-bs-target="#storyUploadModal" style="cursor: pointer;">
                         <div class="story-img-wrapper d-flex align-items-center justify-content-center" style="background: var(--ios-input-bg); border: 2px dashed var(--ios-primary);">
                              <i class="bi bi-plus-lg fs-4 text-primary"></i>
                         </div>
                         <small class="fw-bold" style="font-size: 10px; color: var(--ios-primary);">Add Story</small>
                    </div>

                    {% for story in stories %}
                    <div class="story-item text-center"
                         onclick="viewStory('{% if story.image %}{{ story.image.url }}{% else %}{% endif %}', '{{ story.user.username }}', '{{ story.caption|default_if_none:""|escapejs }}', '{{ story.user.profile.profile_pic.url }}')"
                         style="cursor: pointer;">

                         {% if story.caption %}
                         <div class="story-note-bubble">
                              {{ story.caption }}
                         </div>
                         {% endif %}

                         <div class="story-img-wrapper">
                              {% if story.image %}
                                   <img src="{{ story.user.profile.profile_pic.url }}" class="story-img">
                              {% else %}
                                   <div class="text-story-preview">
                                        {{ story.caption|truncatechars:15 }}
                                   </div>
                              {% endif %}
                         </div>
                         <small class="text-muted d-block text-truncate mx-auto" style="font-size: 10px; width: 60px;">{{ story.user.username }}</small>
                    </div>
                    {% endfor %}
               </div>

               <div class="post-card">
                    <div class="d-flex align-items-center mb-3">
                         <img src="{{ user.profile.profile_pic.url }}" class="rounded-circle me-3" width="45" height="45" style="object-fit: cover; border: 1.5px solid var(--ios-primary);">
                         <span class="fw-bold" style="font-size: 17px;">Hi, {{ user.username }}!</span>
                    </div>
                    <form method="POST" action="{% url 'add_post' %}" enctype="multipart/form-data">
                         {% csrf_token %}
                         <textarea name="content" class="form-control post-input mb-3 shadow-none" rows="2" placeholder="What's on your mind?" required></textarea>
                         <div class="d-flex justify-content-between align-items-center">
                              <label class="action-btn d-flex align-items-center m-0" style="cursor: pointer;">
                                   <i class="bi bi-image text-primary fs-5 me-2"></i><b>Media</b>
                                   <input type="file" name="image" class="d-none" accept="image/*">
                              </label>
                              <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" style="background: var(--ios-primary); border: none;">Publish</button>
                         </div>
                    </form>
               </div>

               <div id="posts-feed">
                    {% for post in posts %}
                    <div class="post-card" id="post-{{ post.id }}">
                         <div class="d-flex justify-content-between align-items-start mb-3">
                              <div class="d-flex align-items-center">
                                   <img src="{{ post.author.profile.profile_pic.url }}" class="rounded-circle me-2" width="40" height="40" style="object-fit: cover;">
                                   <div>
                                        <a href="{% url 'profile_view' post.author.username %}" class="text-decoration-none fw-bold text-reset d-block" style="font-size: 15px;">
                                             {{ post.author.username }}
                                             {% if post.author.profile.role == 'developer' %}
                                                  <i class="bi bi-patch-check-fill role-mark mark-developer"></i>
                                             {% elif post.author.profile.role == 'app_inspector' %}
                                                  <i class="bi bi-check-circle-fill role-mark mark-inspector"></i>
                                             {% elif post.author.profile.role == 'Official' or post.author.username == 'TalkOfficialBot' %}
                                                  <i class="bi bi-patch-check-fill role-mark mark-official"></i>
                                             {% endif %}
                                        </a>
                                        <small class="text-muted" style="font-size: 11px;">{{ post.created_at|timesince }} ago</small>
                                   </div>
                              </div>
                              {% if post.author == user %}
                              <div class="dropdown">
                                   <i class="bi bi-three-dots text-muted px-2" data-bs-toggle="dropdown" style="cursor:pointer;"></i>
                                   <ul class="dropdown-menu dropdown-menu-end shadow border-0" style="border-radius: 12px;">
                                        <li><a class="dropdown-item text-danger fw-bold" href="{% url 'delete_post' post.id %}" onclick="return confirm('Delete post?')">Delete</a></li>
                                   </ul>
                              </div>
                              {% endif %}
                         </div>

                         <p class="mb-3" style="white-space: pre-wrap; font-size: 15px;">{{ post.content }}</p>
                         {% if post.image %}
                         <img src="{{ post.image.url }}" class="img-fluid rounded-4 w-100 mb-3 shadow-sm" style="max-height: 500px; object-fit: cover;">
                         {% endif %}

                         <div class="d-flex gap-4 border-top pt-2">
                              <button onclick="likePost('{{ post.id }}')" class="action-btn d-flex align-items-center p-0">
                                   <i class="bi {% if user in post.likes.all %}bi-heart-fill text-danger{% else %}bi-heart{% endif %} fs-5" id="like-icon-{{ post.id }}"></i>
                                   <span class="ms-2" id="like-count-{{ post.id }}">{{ post.likes.count }}</span>
                              </button>
                              <button class="action-btn d-flex align-items-center p-0" data-bs-toggle="modal" data-bs-target="#commentModal{{ post.id }}">
                                   <i class="bi bi-chat fs-5"></i>
                                   <span class="ms-2" id="comment-count-{{ post.id }}">{{ post.comments.count }}</span>
                              </button>
                         </div>
                    </div>

                    <div class="modal fade" id="commentModal{{ post.id }}" tabindex="-1">
                         <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                              <div class="modal-content border-0" style="border-radius: 25px; background: var(--ios-card-bg);">
                                   <div class="modal-header border-0 pb-0">
                                        <h6 class="fw-bold mx-auto">Comments</h6>
                                        <button type="button" class="btn-close position-absolute end-0 me-3" data-bs-dismiss="modal"></button>
                                   </div>
                                   <div class="modal-body px-4" style="min-height: 400px;">
                                        <div id="inner-comments-{{ post.id }}">
                                             {% for comment in post.comments.all %}
                                                  {% if not comment.parent %}
                                                  <div class="mb-3" id="comment-container-{{ comment.id }}">
                                                       <div class="d-flex gap-2">
                                                            <img src="{{ comment.user.profile.profile_pic.url }}" class="rounded-circle" width="32" height="32" style="object-fit: cover;">
                                                            <div class="flex-grow-1">
                                                                 <div class="comment-bubble">
                                                                      <div class="d-flex justify-content-between align-items-center">
                                                                           <small class="fw-bold text-primary">{{ comment.user.username }}</small>
                                                                           <span class="time-text">{{ comment.created_at|timesince }} ago</span>
                                                                      </div>
                                                                      <div style="font-size: 13.5px;">{{ comment.content }}</div>
                                                                 </div>
                                                                 <div class="mt-1 ms-2">
                                                                      <span class="comment-action-btn" onclick="toggleReplyField('{{ comment.id }}')">Reply</span>
                                                                      {% if comment.user == user %}
                                                                      <span class="comment-action-btn text-danger" onclick="deleteComment('{{ comment.id }}', '{{ post.id }}')">Delete</span>
                                                                      {% endif %}
                                                                 </div>

                                                                 <div id="replies-{{ comment.id }}" class="reply-box mt-2">
                                                                      {% for reply in comment.replies.all %}
                                                                      <div class="d-flex gap-2 mb-2" id="comment-container-{{ reply.id }}">
                                                                           <img src="{{ reply.user.profile.profile_pic.url }}" class="rounded-circle" width="24" height="24" style="object-fit: cover;">
                                                                           <div class="flex-grow-1">
                                                                                <div class="comment-bubble py-1 px-3">
                                                                                     <div class="d-flex justify-content-between">
                                                                                          <small class="fw-bold">{{ reply.user.username }}</small>
                                                                                          <span class="time-text">{{ reply.created_at|timesince }}</span>
                                                                                     </div>
                                                                                     <div style="font-size: 12.5px;">{{ reply.content }}</div>
                                                                                </div>
                                                                                {% if reply.user == user %}
                                                                                <small class="text-danger ms-2" style="cursor:pointer; font-size: 11px;" onclick="deleteComment('{{ reply.id }}', '{{ post.id }}')">Delete</small>
                                                                                {% endif %}
                                                                           </div>
                                                                      </div>
                                                                      {% endfor %}
                                                                 </div>

                                                                 <div id="reply-field-{{ comment.id }}" class="mt-2 d-none">
                                                                      <form onsubmit="submitComment(event, '{{ post.id }}', '{{ comment.id }}')" class="d-flex gap-2">
                                                                           <input type="text" id="input-{{ post.id }}-{{ comment.id }}" class="form-control post-input py-1" placeholder="Write a reply..." required>
                                                                           <button type="submit" class="btn btn-primary btn-sm rounded-circle"><i class="bi bi-arrow-up"></i></button>
                                                                      </form>
                                                                 </div>
                                                            </div>
                                                       </div>
                                                  </div>
                                                  {% endif %}
                                             {% empty %}
                                                  <div class="text-center text-muted mt-5 empty-msg">No comments yet.</div>
                                             {% endfor %}
                                        </div>
                                   </div>
                                   <div class="modal-footer border-0 p-3">
                                        <form onsubmit="submitComment(event, '{{ post.id }}')" class="w-100 d-flex gap-2">
                                             <input type="text" id="input-{{ post.id }}" class="form-control post-input" placeholder="Add a comment..." required autocomplete="off">
                                             <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 42px; height: 42px; background: var(--ios-primary); border: none;">
                                                  <i class="bi bi-arrow-up text-white fs-5"></i>
                                             </button>
                                        </form>
                                   </div>
                              </div>
                         </div>
                    </div>
                    {% endfor %}
               </div>
          </div>
     </div>
</div>

<div class="modal fade" id="storyUploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
         <div class="modal-content border-0" style="border-radius: 25px; background: var(--ios-card-bg);">
              <form method="POST" action="{% url 'add_story' %}" enctype="multipart/form-data">
                   {% csrf_token %}
                   <div class="modal-header border-0">
                        <h6 class="fw-bold mx-auto">Create Story</h6>
                        <button type="button" class="btn-close position-absolute end-0 me-3" data-bs-dismiss="modal"></button>
                   </div>
                   <div class="modal-body">
                        <textarea name="caption" class="form-control post-input mb-3 shadow-none" rows="3" placeholder="What's your note? (Text only story is okay!)" required></textarea>
                        <div class="mb-3">
                             <label class="form-label small text-muted">Upload Photo (Optional)</label>
                             <input type="file" name="image" class="form-control post-input shadow-none" accept="image/*">
                        </div>
                   </div>
                   <div class="modal-footer border-0">
                        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold" style="background: var(--ios-primary); border: none;">Share Story</button>
                   </div>
              </form>
         </div>
    </div>
</div>

<div class="modal fade" id="storyViewModal" tabindex="-1">
     <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content bg-dark border-0 overflow-hidden" style="border-radius: 20px;">
               <div class="modal-body p-0 position-relative">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>

                    <div id="storyViewerContent" class="d-flex align-items-center justify-content-center" style="min-height: 500px; background: #000;">
                         <img id="storyViewImg" src="" class="w-100" style="display: none; max-height: 85vh; object-fit: contain;">
                         <div id="storyViewText" class="p-5 text-white text-center fs-4 fw-bold w-100" style="display: none; height: 100%; display: flex; align-items: center; justify-content: center;"></div>
                    </div>

                    <div class="position-absolute bottom-0 start-0 w-100 p-3 bg-gradient-dark text-white d-flex align-items-center gap-3" style="background: linear-gradient(transparent, rgba(0,0,0,0.8));">
                         <img id="storyUserPic" src="" class="rounded-circle border border-2 border-white" width="40" height="40" style="object-fit: cover;">
                         <div class="text-start">
                              <h6 id="storyViewUser" class="fw-bold mb-0"></h6>
                              <p id="storyViewCaption" class="small mb-0 opacity-75"></p>
                         </div>
                    </div>
               </div>
          </div>
     </div>
</div>

<script>
     // Story Viewer Logic
     function viewStory(imgUrl, username, caption, userPic) {
          const imgElement = document.getElementById('storyViewImg');
          const textElement = document.getElementById('storyViewText');
          const container = document.getElementById('storyViewerContent');

          document.getElementById('storyViewUser').innerText = username;
          document.getElementById('storyViewCaption').innerText = caption;
          document.getElementById('storyUserPic').src = userPic;

          // Clear previous styles
          container.style.background = "#000";

          if (imgUrl && imgUrl !== "" && imgUrl !== "/media/") {
               imgElement.src = imgUrl;
               imgElement.style.display = "block";
               textElement.style.display = "none";
          } else {
               imgElement.style.display = "none";
               textElement.innerText = caption;
               textElement.style.display = "flex"; // Use flex for centering
               container.style.background = "linear-gradient(45deg, #5856d6, #007AFF)";
          }

          var myModal = new bootstrap.Modal(document.getElementById('storyViewModal'));
          myModal.show();
     }

     function toggleReplyField(commentId) {
          const field = document.getElementById(`reply-field-${commentId}`);
          field.classList.toggle('d-none');
          if(!field.classList.contains('d-none')) field.querySelector('input').focus();
     }

     // Like Logic
     function likePost(postId) {
          fetch(`/like/${postId}/`, {
               method: 'POST',
               headers: { 'X-CSRFToken': '{{ csrf_token }}' }
          })
          .then(res => res.json())
          .then(data => {
               const icon = document.getElementById(`like-icon-${postId}`);
               const count = document.getElementById(`like-count-${postId}`);
               if(data.liked) {
                    icon.classList.replace('bi-heart', 'bi-heart-fill');
                    icon.classList.add('text-danger');
               } else {
                    icon.classList.replace('bi-heart-fill', 'bi-heart');
                    icon.classList.remove('text-danger');
               }
               count.innerText = data.like_count;
          });
     }

     // Comment & Reply Logic
     async function submitComment(event, postId, parentId = null) {
          event.preventDefault();
          const inputId = parentId ? `input-${postId}-${parentId}` : `input-${postId}`;
          const input = document.getElementById(inputId);
          if (!input.value.trim()) return;

          const formData = new FormData();
          formData.append('content', input.value);
          if (parentId) formData.append('parent_id', parentId);

          const res = await fetch(`/add_comment/${postId}/`, {
               method: 'POST',
               body: formData,
               headers: { 'X-CSRFToken': '{{ csrf_token }}' }
          });

          const data = await res.json();
          if (data.status === 'success') {
               input.value = '';
               location.reload();
          }
     }

     async function deleteComment(commentId, postId) {
          if (!confirm('Delete comment?')) return;
          const res = await fetch(`/comment/delete/${commentId}/`, {
               method: 'POST',
               headers: { 'X-CSRFToken': '{{ csrf_token }}' }
          });
          if (res.ok) {
               document.getElementById(`comment-container-${commentId}`).remove();
               const countLabel = document.getElementById(`comment-count-${postId}`);
               if (countLabel) {
                    countLabel.innerText = Math.max(0, parseInt(countLabel.innerText) - 1);
               }
          }
     }
</script>
{% endblock %}